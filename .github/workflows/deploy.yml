name: ðŸš€ Deploy Full Stack Application

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [closed]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: us-east-1
  NODE_VERSION: "20"

jobs:
  # =======================================
  # ðŸ§ª TEST & LINT JOBS
  # =======================================

  test-frontend:
    name: ðŸ§ª Test Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./website

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¦ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ“¦ Install frontend dependencies
        run: bun install

      - name: ðŸ” Lint frontend code
        run: bun run lint

      - name: ðŸ—ï¸ Build frontend
        run: bun run build

  test-backend:
    name: ðŸ§ª Test Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: ðŸ“¦ Install backend dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build backend
        run: npm run build

      - name: ðŸ§ª Run backend tests
        run: npm test

  # =======================================
  # ðŸš€ DEPLOYMENT JOBS
  # =======================================

  deploy-backend:
    name: ðŸ—ï¸ Deploy Backend Infrastructure
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true))
    defaults:
      run:
        working-directory: ./backend

    outputs:
      graphql-endpoint: ${{ steps.deploy.outputs.graphql-endpoint }}
      identity-pool-id: ${{ steps.deploy.outputs.identity-pool-id }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: ðŸŸ¦ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build TypeScript
        run: npm run build

      - name: ðŸ” Pre-deployment checks
        run: bun run check

      - name: ðŸš€ Deploy backend infrastructure
        id: deploy
        run: |
          echo "ðŸš€ Deploying backend infrastructure..."
          bun run deploy:full

          # Capture outputs
          echo "ðŸ“Š Capturing CloudFormation outputs..."
          GRAPHQL_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name BackendStack \
            --query 'Stacks[0].Outputs[?OutputKey==`GraphQLEndpoint`].OutputValue' \
            --output text \
            --region ${{ env.AWS_REGION }})
            
          IDENTITY_POOL_ID=$(aws cloudformation describe-stacks \
            --stack-name BackendStack \
            --query 'Stacks[0].Outputs[?OutputKey==`IdentityPoolId`].OutputValue' \
            --output text \
            --region ${{ env.AWS_REGION }})

          echo "graphql-endpoint=$GRAPHQL_ENDPOINT" >> $GITHUB_OUTPUT
          echo "identity-pool-id=$IDENTITY_POOL_ID" >> $GITHUB_OUTPUT

          echo "âœ… Backend deployed successfully!"
          echo "ðŸ”— GraphQL Endpoint: $GRAPHQL_ENDPOINT"
          echo "ðŸ†” Identity Pool ID: $IDENTITY_POOL_ID"

      - name: ðŸŒ± Seed database
        run: |
          echo "ðŸŒ± Seeding database with sample data..."
          bun run seed:small
          echo "âœ… Database seeded successfully!"

  deploy-frontend:
    name: ðŸŒ Deploy Frontend to Amplify
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true))

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ”„ Update Amplify environment variables
        run: |
          echo "ðŸ”§ Updating Amplify environment variables..."

          # Get Amplify App ID from CloudFormation
          AMPLIFY_APP_ID=$(aws cloudformation describe-stacks \
            --stack-name HostingStack \
            --query 'Stacks[0].Outputs[?OutputKey==`AmplifyAppId`].OutputValue' \
            --output text \
            --region ${{ env.AWS_REGION }}) || echo "No HostingStack found"

          if [ "$AMPLIFY_APP_ID" != "No HostingStack found" ] && [ -n "$AMPLIFY_APP_ID" ]; then
            echo "ðŸ“± Found Amplify App ID: $AMPLIFY_APP_ID"
            
            # Update environment variables
            aws amplify put-app \
              --app-id $AMPLIFY_APP_ID \
              --environment-variables \
                NEXT_PUBLIC_GRAPHQL_ENDPOINT="${{ needs.deploy-backend.outputs.graphql-endpoint }}" \
                NEXT_PUBLIC_AWS_REGION="${{ env.AWS_REGION }}" \
                NEXT_PUBLIC_IDENTITY_POOL_ID="${{ needs.deploy-backend.outputs.identity-pool-id }}" \
              --region ${{ env.AWS_REGION }}
            
            echo "âœ… Environment variables updated successfully!"
            
            # Trigger new deployment
            echo "ðŸš€ Triggering Amplify deployment..."
            aws amplify start-job \
              --app-id $AMPLIFY_APP_ID \
              --branch-name main \
              --job-type RELEASE \
              --region ${{ env.AWS_REGION }}
              
            echo "âœ… Amplify deployment triggered!"
          else
            echo "âš ï¸ Amplify app not found or not deployed via CDK. Manual Amplify setup required."
          fi

  # =======================================
  # ðŸ§¹ CLEANUP & NOTIFICATIONS
  # =======================================

  notify-deployment:
    name: ðŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Status**: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Status**: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GraphQL Endpoint**: ${{ needs.deploy-backend.outputs.graphql-endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Identity Pool**: ${{ needs.deploy-backend.outputs.identity-pool-id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
            echo "âœ… **All deployments successful!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some deployments failed. Check logs above.**" >> $GITHUB_STEP_SUMMARY
          fi
